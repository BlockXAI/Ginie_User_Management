generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model users {
  id                                                String         @id @db.Uuid
  email                                             String         @unique @db.Citext
  email_verified_at                                 DateTime?      @map("email_verified_at") @db.Timestamp(6)
  display_name                                      String?
  wallet_address                                    String?
  role                                              String         @default("normal")
  metadata                                          Json           @default("{}")
  created_at                                        DateTime       @default(now()) @db.Timestamp(6)
  updated_at                                        DateTime       @default(now()) @db.Timestamp(6)
  audit_logs                                        audit_logs[]
  entitlements                                      entitlements?
  premium_keys_premium_keys_issued_by_adminTousers  premium_keys[] @relation("premium_keys_issued_by_adminTousers")
  premium_keys_premium_keys_redeemed_by_userTousers premium_keys[] @relation("premium_keys_redeemed_by_userTousers")
  sessions                                          sessions[]
  user_jobs                                         user_jobs[]

  @@index([role], map: "idx_users_role")
}

model sessions {
  id             String    @id @db.Uuid
  user_id        String    @db.Uuid
  session_hash   String    @unique
  refresh_hash   String?   @unique
  expires_at     DateTime  @db.Timestamp(6)
  device_info    Json      @default("{}")
  ip             String?   @db.Inet
  last_active_at DateTime? @db.Timestamp(6)
  revoked_at     DateTime? @db.Timestamp(6)
  users          users     @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model entitlements {
  user_id            String  @id @db.Uuid
  pro_enabled        Boolean @default(false)
  wallet_deployments Boolean @default(false)
  history_export     Boolean @default(false)
  chat_agents        Boolean @default(false)
  hosted_frontend    Boolean @default(false)
  limits             Json    @default("{}")
  users              users   @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
}

model premium_keys {
  id                                         String    @id @db.Uuid
  secret_hash                                String
  issued_by_admin                            String    @db.Uuid
  status                                     String
  redeemed_by_user                           String?   @db.Uuid
  expires_at                                 DateTime? @db.Timestamp(6)
  created_at                                 DateTime  @default(now()) @db.Timestamp(6)
  users_premium_keys_issued_by_adminTousers  users     @relation("premium_keys_issued_by_adminTousers", fields: [issued_by_admin], references: [id], onDelete: NoAction, onUpdate: NoAction)
  users_premium_keys_redeemed_by_userTousers users?    @relation("premium_keys_redeemed_by_userTousers", fields: [redeemed_by_user], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([status], map: "idx_premium_keys_status")
  @@index([expires_at], map: "idx_premium_keys_expires_at")
}

model user_jobs {
  job_id     String   @id
  user_id    String   @db.Uuid
  type       String   @default("pipeline")
  prompt     String?
  filename   String?
  network    String
  created_at DateTime @default(now()) @db.Timestamp(6)
  users      users    @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([user_id, created_at(sort: Desc)], map: "idx_user_jobs_user_created_at")
  @@index([type, created_at(sort: Desc)], map: "idx_user_jobs_type_created_at")
}

model job_cache {
  job_id           String    @id
  state            String
  progress         Int       @default(0)
  address          String?
  fq_name          String?
  constructor_args Json      @default("[]")
  verified         Boolean   @default(false)
  explorer_url     String?
  completed_at     DateTime? @db.Timestamp(6)
  updated_at       DateTime  @default(now()) @db.Timestamp(6)

  @@index([state], map: "idx_job_cache_state")
  @@index([updated_at(sort: Desc)], map: "idx_job_cache_updated_at")
}

model audit_logs {
  id         String   @id @db.Uuid
  user_id    String?  @db.Uuid
  event      String
  metadata   Json     @default("{}")
  created_at DateTime @default(now()) @db.Timestamp(6)
  users      users?   @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([user_id, created_at(sort: Desc)], map: "idx_audit_logs_user_created")
  @@index([event, created_at(sort: Desc)], map: "idx_audit_logs_event_created")
}
